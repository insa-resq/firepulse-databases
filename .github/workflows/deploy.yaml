name: Deploy databases

on:
    push:
        branches: [main]
    workflow_dispatch:

env:
    DEPLOYMENT_PATH: ~/

permissions:
    contents: read

jobs:
    deploy:
        name: Deploy
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout Code
                uses: actions/checkout@v5
                with:
                    persist-credentials: false

            -   name: Copy files to remote server
                uses: appleboy/scp-action@v1.0.0
                with:
                    host: ${{ secrets.SSH_HOST }}
                    username: ${{ secrets.SSH_USERNAME }}
                    password: ${{ secrets.SSH_PASSWORD }}
                    source: "src/*"
                    target: ${{ env.DEPLOYMENT_PATH }}
                    capture_stdout: true

            -   name: Execute deployment commands
                uses: appleboy/ssh-action@v1.2.2
                with:
                    host: ${{ secrets.SSH_HOST }}
                    username: ${{ secrets.SSH_USERNAME }}
                    password: ${{ secrets.SSH_PASSWORD }}
                    script: |
                        set -e
                        
                        cd ${{ env.DEPLOYMENT_PATH }}
                        cd src
                        
                        chmod +x ./scripts/install-docker.sh
                        sudo ./scripts/install-docker.sh
                        
                        cat <<EOF > .env
                        POSTGRES_DB=${{ secrets.POSTGRES_DB }}
                        POSTGRES_USER=${{ secrets.POSTGRES_USER }}
                        POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
                        DATABASE_URL="postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_DB }}"
                        EOF
                        
                        docker compose up --build -d --wait
                        docker system prune -f                        
